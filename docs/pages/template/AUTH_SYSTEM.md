# Система аутентификации и авторизации

## Описание архитектуры

Данная система реализует собственную аутентификацию и авторизацию на основе JWT токенов и ролевой модели доступа (RBAC - Role-Based Access Control) с гранулярными правами.

## Схема базы данных

### 1. Таблица `users` (расширение стандартной User модели Django)
Основная таблица пользователей со следующими полями:
- `id` - первичный ключ
- `email` - уникальный email (используется для входа)
- `password` - хешированный пароль (bcrypt)
- `first_name` - имя
- `last_name` - фамилия
- `middle_name` - отчество
- `is_active` - статус активности (для мягкого удаления)
- `created_at` - дата создания
- `updated_at` - дата обновления

### 2. Таблица `roles`
Справочник ролей в системе:
- `id` - первичный ключ
- `name` - название роли (уникальное)
- `code` - код роли (admin, manager, user, guest)
- `description` - описание роли
- `created_at` - дата создания

Предустановленные роли:
- **admin** - Администратор (полный доступ ко всему)
- **manager** - Менеджер (управление бизнес-объектами)
- **user** - Пользователь (доступ к своим данным)
- **guest** - Гость (только чтение публичных данных)

### 3. Таблица `user_roles`
Связь пользователей и ролей (Many-to-Many):
- `id` - первичный ключ
- `user_id` - внешний ключ на users
- `role_id` - внешний ключ на roles
- `assigned_at` - дата назначения роли
- `assigned_by` - кто назначил (внешний ключ на users, nullable)

### 4. Таблица `business_elements`
Справочник бизнес-объектов приложения:
- `id` - первичный ключ
- `name` - название объекта
- `code` - код объекта (users, products, stores, orders, access_rules)
- `description` - описание объекта
- `created_at` - дата создания

Предустановленные элементы:
- **users** - Пользователи системы
- **products** - Товары
- **stores** - Магазины
- **orders** - Заказы
- **access_rules** - Правила доступа (управление самой системой авторизации)

### 5. Таблица `access_rules`
Правила доступа роли к бизнес-элементу:
- `id` - первичный ключ
- `role_id` - внешний ключ на roles
- `element_id` - внешний ключ на business_elements
- `read_permission` - может читать свои объекты
- `read_all_permission` - может читать все объекты
- `create_permission` - может создавать объекты
- `update_permission` - может обновлять свои объекты
- `update_all_permission` - может обновлять все объекты
- `delete_permission` - может удалять свои объекты
- `delete_all_permission` - может удалять все объекты
- `created_at` - дата создания
- `updated_at` - дата обновления

### 6. Таблица `sessions`
Сессии пользователей для отслеживания активных токенов:
- `id` - первичный ключ
- `user_id` - внешний ключ на users
- `token` - JWT токен (хешированный)
- `refresh_token` - refresh токен (хешированный)
- `expires_at` - время истечения токена
- `refresh_expires_at` - время истечения refresh токена
- `ip_address` - IP адрес клиента
- `user_agent` - User-Agent браузера
- `is_active` - активна ли сессия
- `created_at` - время создания

## Процесс аутентификации

### Регистрация
1. Пользователь отправляет данные: email, password, password_confirm, first_name, last_name, middle_name
2. Система проверяет уникальность email
3. Проверяется совпадение паролей
4. Пароль хешируется с использованием bcrypt
5. Создается пользователь со статусом is_active=True
6. Автоматически назначается роль "user"
7. Возвращается информация о созданном пользователе

### Login
1. Пользователь отправляет email и password
2. Система находит пользователя по email
3. Проверяется is_active=True
4. Сравнивается хеш пароля
5. Генерируется JWT access token (срок жизни: 15 минут)
6. Генерируется JWT refresh token (срок жизни: 7 дней)
7. Создается запись в таблице sessions
8. Возвращаются оба токена

### Идентификация пользователя
1. Клиент отправляет запрос с заголовком: `Authorization: Bearer {access_token}`
2. Custom middleware извлекает токен из заголовка
3. Токен декодируется и проверяется на валидность (подпись, срок действия)
4. Из токена извлекается user_id
5. Проверяется существование активной сессии с этим токеном
6. Загружается пользователь и его роли
7. request.user устанавливается для дальнейшей обработки

### Logout
1. Пользователь отправляет запрос с токеном
2. Находится соответствующая сессия
3. Сессия помечается как неактивная (is_active=False)
4. Возвращается успешный ответ

### Refresh Token
1. Клиент отправляет refresh_token
2. Проверяется валидность refresh токена
3. Генерируются новые access и refresh токены
4. Обновляется запись в sessions
5. Возвращаются новые токены

## Процесс авторизации

### Проверка прав доступа
1. После аутентификации определяется пользователь (request.user)
2. Загружаются все роли пользователя
3. Для запрошенного ресурса определяется business_element
4. Загружаются все access_rules для ролей пользователя и данного элемента
5. Проверяется наличие необходимого permission для выполняемого действия:
   - GET (список) -> read_all_permission
   - GET (детально) -> read_permission или read_all_permission
   - POST -> create_permission
   - PUT/PATCH -> update_permission (свой объект) или update_all_permission
   - DELETE -> delete_permission (свой объект) или delete_all_permission

### Проверка владельца объекта
Для операций, требующих разграничения "свой/чужой объект":
1. Объект должен иметь поле owner_id
2. Сравнивается owner_id с request.user.id
3. Если совпадает - проверяется permission (например, update_permission)
4. Если не совпадает - проверяется _all_permission (например, update_all_permission)

### Коды ошибок
- **401 Unauthorized** - пользователь не аутентифицирован (нет токена, невалидный токен, истек срок действия)
- **403 Forbidden** - пользователь аутентифицирован, но не имеет прав на запрашиваемое действие

## API Endpoints

### Аутентификация
- `POST /api/auth/register/` - регистрация нового пользователя
- `POST /api/auth/login/` - вход в систему
- `POST /api/auth/logout/` - выход из системы
- `POST /api/auth/refresh/` - обновление access токена
- `GET /api/auth/me/` - получение информации о текущем пользователе
- `PUT /api/auth/me/` - обновление информации профиля
- `DELETE /api/auth/me/` - мягкое удаление аккаунта

### Управление пользователями (только для администраторов)
- `GET /api/users/` - список всех пользователей
- `GET /api/users/{id}/` - детальная информация о пользователе
- `POST /api/users/` - создание пользователя
- `PUT /api/users/{id}/` - обновление пользователя
- `DELETE /api/users/{id}/` - удаление пользователя

### Управление ролями (только для администраторов)
- `GET /api/roles/` - список ролей
- `GET /api/roles/{id}/` - детальная информация о роли
- `POST /api/roles/` - создание роли
- `PUT /api/roles/{id}/` - обновление роли
- `DELETE /api/roles/{id}/` - удаление роли

### Назначение ролей (только для администраторов)
- `POST /api/users/{id}/roles/` - назначить роль пользователю
- `DELETE /api/users/{id}/roles/{role_id}/` - отозвать роль у пользователя

### Управление правами доступа (только для администраторов)
- `GET /api/access-rules/` - список всех правил доступа
- `GET /api/access-rules/{id}/` - детальная информация о правиле
- `POST /api/access-rules/` - создание правила доступа
- `PUT /api/access-rules/{id}/` - обновление правила
- `DELETE /api/access-rules/{id}/` - удаление правила

### Mock бизнес-объекты (для демонстрации авторизации)
- `GET /api/products/` - список продуктов
- `GET /api/products/{id}/` - детальная информация о продукте
- `POST /api/products/` - создание продукта
- `PUT /api/products/{id}/` - обновление продукта
- `DELETE /api/products/{id}/` - удаление продукта

Аналогично для `/api/stores/` и `/api/orders/`

## Примеры использования

### Регистрация
```bash
curl -X POST http://localhost:8000/api/auth/register/ \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123!",
    "password_confirm": "SecurePass123!",
    "first_name": "Иван",
    "last_name": "Иванов",
    "middle_name": "Иванович"
  }'
```

### Вход
```bash
curl -X POST http://localhost:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123!"
  }'
```

### Доступ к защищенному ресурсу
```bash
curl -X GET http://localhost:8000/api/products/ \
  -H "Authorization: Bearer {access_token}"
```

## Тестовые данные

При первом запуске системы автоматически создаются:
1. Роли: admin, manager, user, guest
2. Бизнес-элементы: users, products, stores, orders, access_rules
3. Правила доступа по умолчанию для каждой роли
4. Тестовый администратор: admin@example.com / Admin123!

## Безопасность

1. Пароли хешируются с использованием bcrypt (минимум 12 раундов)
2. JWT токены подписываются секретным ключом
3. Access токены имеют короткий срок жизни (15 минут)
4. Refresh токены хранятся в БД в хешированном виде
5. При logout сессия деактивируется
6. Отслеживается IP и User-Agent для обнаружения подозрительной активности
7. Мягкое удаление пользователей (is_active=False)

## Технологический стек

- **Django 5+** - веб-фреймворк
- **Django REST Framework** - для создания API
- **PostgreSQL** - база данных
- **PyJWT** - для работы с JWT токенами
- **bcrypt** - для хеширования паролей
